# Behavior of the reference C-impl when a client requests content with `dc=203`

Below is an analysis strictly based on the MTProxy C source code.

## 1. Origin of the `dc` parameter

In obfuscated mode (`extmode2`), the `dc` parameter is extracted from the decrypted 64-byte initialization header:

- The `tag` field is read from `random_header + 56`.
- The `target` field (which represents the destination DC) is read as a `short` from `random_header + 60`.
- This value is then stored in `D->extra_int4`.

References:  
`MTProxy/net/net-tcp-rpc-ext-server.c:1310`  
`MTProxy/net/net-tcp-rpc-ext-server.c:1335`  
`MTProxy/net/net-tcp-rpc-ext-server.c:1336`

As a result, when a client connects with `dc=203`, the connection state will contain:  
`TCP_RPC_DATA(c)->extra_int4 == 203`.

## 2. How `dc=203` is used for routing

Each incoming MTProto packet is passed to `forward_mtproto_packet(...)`, which internally calls:

- `choose_proxy_target(TCP_RPC_DATA(C)->extra_int4)`

References:  
`MTProxy/mtproto/mtproto-proxy.c:1682`  
`MTProxy/mtproto/mtproto-proxy.c:1712`

The function `choose_proxy_target(203)` performs the following steps:

1. Attempts to locate a cluster with `cluster_id=203` using  
   `mf_cluster_lookup(CurConf, target_dc, 1)`.
2. If no cluster with ID `203` exists, the configured `default_cluster` is used due to `force=1`.
3. Up to five attempts are made to select a random target within the cluster, ensuring that a valid and ready outbound connection exists.

References:  
`MTProxy/mtproto/mtproto-proxy.c:1654`  
`MTProxy/mtproto/mtproto-proxy.c:1656`  
`MTProxy/mtproto/mtproto-proxy.c:1661`

## 3. What exactly is forwarded

MTProxy does not inspect or interpret the Telegram request at the application or business logic level. Its processing is limited to the following transport-level operations:

1. Parsing the MTProto transport envelope (encrypted or unencrypted).
2. Selecting the upstream target based on the `dc` parameter.
3. Transparently forwarding the payload unchanged via `RPC_PROXY_REQ`.

References:  
`MTProxy/mtproto/mtproto-proxy.c:1688`  
`MTProxy/mtproto/mtproto-proxy.c:1695`  
`MTProxy/mtproto/mtproto-proxy.c:1794`

## 4. Behavior when no route or connection is available

If no valid outbound connection can be found for the selected cluster (in this case `203`, or the default fallback cluster), the following occurs:

- The request is dropped (`dropped_queries++`).
- The flag `RPC_F_DROPPED` is set on the ext connection.
- Subsequent packets may result in termination of the client connection.

References:  
`MTProxy/mtproto/mtproto-proxy.c:1766`  
`MTProxy/mtproto/mtproto-proxy.c:1770`  
`MTProxy/mtproto/mtproto-proxy.c:1774`

## 5. Response path (upstream â†’ client)

Responses from the upstream are received as `RPC_PROXY_ANS`:

1. The corresponding ext connection is located using `out_conn_id`.
2. The response is forwarded to the client via `client_send_message`.
3. If no valid connection mapping is found, an `RPC_CLOSE_CONN` is sent upstream.

References:  
`MTProxy/mtproto/mtproto-proxy.c:840`  
`MTProxy/mtproto/mtproto-proxy.c:846`  
`MTProxy/mtproto/mtproto-proxy.c:854`  
`MTProxy/mtproto/mtproto-proxy.c:858`

## 6. Configuration requirements for dedicated routing of `dc=203`

The configuration parser supports explicit DC-based routing using the `proxy_for <dc> ...` directive:

- `proxy_for 203 <ip>:<port>;` creates or extends a cluster with `cluster_id=203`.
- `default <dc>;` defines the fallback cluster for DCs without explicit routing rules.

References:  
`MTProxy/mtproto/mtproto-config.c:86`  
`MTProxy/mtproto/mtproto-config.c:101`  
`MTProxy/mtproto/mtproto-config.c:275`  
`MTProxy/mtproto/mtproto-config.c:298`  
`MTProxy/mtproto/mtproto-config.c:350`

## Summary for the `dc=203` case

- The value `203` is extracted from the initial obfuscated transport header and stored in `extra_int4`.
- All packets belonging to that client session are deterministically routed via the cluster with ID `203`.
- If cluster `203` is not configured, routing falls back to the configured default cluster.
- The actual MTProto payload content has no influence on DC selection; only the `target_dc` value in the transport header determines routing.
